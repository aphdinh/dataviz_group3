<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title></title>
    <!-- Leaflet stylesheet -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css"
      integrity="sha512-Rksm5RenBEKSKFjgI3a41vrjkw4EVPlJ3+OiI65vTjIdo9brlAacEuKOiQ5OFh7cOI1bkDwLqdLw3Zg0cRJAAQ=="
      crossorigin=""
    />
    <!-- Leaflet -->
    <script
      src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js"
      integrity="sha512-/Nsx9X4HebavoBvEBuyp3I7od5tA0UzAxs+j83KgC8PU0kgB4XiK4Lfe4y4cgBtaRJQEIFCW+oC506aPT2L1zw=="
      crossorigin=""
    ></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

    <script src="https://api.tiles.mapbox.com/mapbox-gl-js/v0.45.0/mapbox-gl.js"></script>
    <link
      href="https://api.tiles.mapbox.com/mapbox-gl-js/v0.45.0/mapbox-gl.css"
      rel="stylesheet"
    />
    <script src="europe.js"></script>

    <link
      href="https://fonts.googleapis.com/css?family=Playfair+Display+SC|Roboto"
      rel="stylesheet"
    />
  </head>

  <style>
    #mapid {
      height: 600px;
    }

    .info {
      background-color: #545454;
      width: auto;
      color: white;
      padding: 1em;
      font-family: 'Roboto', sans-serif;
    }

    .info h2 {
      padding: 0;
      margin-top: 0;
      font-family: 'Playfair Display SC', serif;
    }

    .info h3 {
      padding: none;
      font-weight: bold;
      font-style: italic;
      color: #ffd32a;
    }

    .legend {
      line-height: 18px;
      /*color: #555;*/
      color: white;
      width: auto;
    }

    .legend i {
      width: 18px;
      height: 18px;
      float: left;
      margin-right: 8px;
      opacity: 0.7;
    }

    /* Custom styles for popup */
    .leaflet-popup-content-wrapper {
      width: 400px; /* Increased width */
      height: 300px; /* Increased height */
    }

    .leaflet-popup-content {
      width: 100%;
      height: 100%;
    }
  </style>

  <body>
    <div id="mapid"></div>

    <script>
      var geojson;

      // Lat/Long for Prague
      var lat = 50.0755381;
      var long = 14.43780049999998;

      var mymap = L.map('mapid').setView([lat, long], 13); //([51.505, -0.09], 13);

      L.tileLayer(
        '  https://api.mapbox.com/styles/v1/mapbox/dark-v9/tiles/256/{z}/{x}/{y}?access_token=pk.eyJ1Ijoibmlja255ciIsImEiOiJjajduNGptZWQxZml2MndvNjk4eGtwbDRkIn0.L0aWwfHlFJVGa-WOj7EHaA',
        {
          attribution:
            'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
          maxZoom: 4,
          minZoom: 3,
          id: 'mapbox.dark',
        }
      ).addTo(mymap);

      mymap.panTo(new L.LatLng(lat, long));

      function getColor(d) {
        return d > 10000
          ? '#005824'
          : d > 5000
          ? '#238b45'
          : d > 3000
          ? '#41ae76'
          : d > 1000
          ? '#66c2a4'
          : d > 500
          ? '#99d8c9'
          : 'snow';
      }

      function style(feature) {
        return {
          fillColor: getColor(feature.properties.total_orders_country),
          weight: 1,
          opacity: 1,
          color: 'snow',
          //dashArray: '2',
          fillOpacity: 0.7,
          stroke: true,
          weight: 0.7,
          fill: true,
          clickable: true,
        };
      }

      // Happens on mouse hover
      function highlightFeature(e) {
        var layer = e.target;

        layer.setStyle({
          weight: 2,
          color: '#ffd32a',
          dashArray: '',
          fillOpacity: 0.7,
        });

        if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
          layer.bringToFront();
        }

        info.update(layer.feature.properties);
      }

      // Happens on mouse out
      function resetHighlight(e) {
        geojson.resetStyle(e.target);
        info.update();
      }

      // Click listener that zooms to country
      function zoomToFeature(e) {
        mymap.fitBounds(e.target.getBounds());
      }

      function onEachFeature(feature, layer) {
        layer.on({
          mouseover: highlightFeature,
          mouseout: resetHighlight,
          click: function (e) {
            var layer = e.target;
            var popupContent =
              '<h3>Order Delays</h3>' +
              'Delays: ' +
              layer.feature.properties.order_delays_countries +
              ' orders';
            layer.bindPopup(popupContent).openPopup();
          },
        });
      }

      geojson = L.geoJson(countriesData, {
        style: style,
        onEachFeature: onEachFeature,
      }).addTo(mymap);

      // Legend
      var legend = L.control({ position: 'bottomright' });

      legend.onAdd = function (map) {
        var div = L.DomUtil.create('div', 'info legend'),
          grades = [500, 1000, 3000, 5000, 10000], // Thresholds for the legend
          labels = [];

        // Create a label for each interval
        for (var i = 0; i < grades.length; i++) {
          labels.push(
            '<i style="background:' +
              getColor(grades[i] + 1) +
              '"></i> ' +
              grades[i] +
              (grades[i + 1]
                ? '&ndash;' + grades[i + 1] + ' orders'
                : '+ orders')
          );
        }

        // Insert the header for the legend
        div.innerHTML = '<h3>Total Number of Orders</h3>' + labels.join('<br>');
        return div;
      };

      legend.addTo(mymap);

      // Custom control
      var info = L.control();

      info.onAdd = function (map) {
        this._div = L.DomUtil.create('div', 'info'); // create a div with a class "info"
        this.update();
        return this._div;
      };

      // method that we will use to update the control based on feature properties passed
      info.update = function (props) {
        this._div.innerHTML =
          '<h2>Distribution center of each country</h2>' +
          (props
            ? '<h3>' +
              props.admin +
              '</h3>' +
              '<b>' +
              'Distribution center: ' +
              '</b>' +
              props.distribution_center_x +
              '<br />' +
              '<b>' +
              ' Total number of order: ' +
              '</b>' +
              props.total_orders_country / 1000 +
              '<br />' +
              '<b>' +
              'Total number of sales center:' +
              '</b>' +
              '<br />' +
              props.total_sales_center +
              '<br />' +
              '<b>' +
              'Total number of customers:' +
              '</b>' +
              '<br />' +
              props.customers_per_country
            : 'Hover over an European country');
      };

      info.addTo(mymap);

      console.log(countriesData);
    </script>
  </body>
</html>
